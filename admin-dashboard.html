<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المدرب</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">لوحة المدرب</div>
    <div class="actions">
      <button class="btn" onclick="logoutAdmin()">خروج المدرب</button>
    </div>
  </div>

  <div class="card">
    <div class="h2">اختيار المقرر والشعبة</div>
    <div class="row" style="margin-top:10px">
      <select id="courseSel" class="input"></select>
      <select id="sectionSel" class="input"></select>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" onclick="apply()">تطبيق</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="h2">الخدمات</div>
    <div class="muted">ستفتح الصفحات حسب المقرر/الشعبة المختارة.</div>
    <div class="grid" style="margin-top:10px">
      <a class="btn" id="gLink" href="#">سجل الدرجات</a>
      <a class="btn" id="aLink" href="#">سجل الحضور</a>
      <a class="btn" id="pLink" href="policies.html">سياسات المقرر</a>
      <a class="btn" id="rLink" href="#rem">التذكيرات</a>
    </div>
  </div>

  <div class="card" id="rem" style="margin-top:12px">
    <div class="h2">إضافة تذكير (حسب المقرر)</div>
    <div class="row" style="margin-top:10px">
      <input id="rTitle" class="input" placeholder="عنوان التذكير">
      <input id="rEnd" class="input" type="datetime-local">
    </div>
    <div class="row" style="margin-top:10px">
      <input id="rNote" class="input" placeholder="ملاحظة (اختياري)">
      <button class="btn primary" onclick="addReminder()">إضافة</button>
    </div>
    <div id="remList" style="margin-top:10px"></div>
  </div>

</div>

<script src="assets/app.js"></script>
<script>
let map = [];

function fillCourses(items){
  courseSel.innerHTML = `<option value="">اختر المقرر</option>` +
    items.map(it => `<option value="${esc(it.course)}">${esc(it.course)}</option>`).join("");

  // restore
  const c = getAdminCourse();
  if (c) courseSel.value = c;
  fillSections(items);
}

function fillSections(items){
  const c = courseSel.value;
  const found = items.find(x => x.course === c);
  const sections = (found && found.sections) ? found.sections : [];
  sectionSel.innerHTML = `<option value="">كل الشعب</option>` +
    sections.map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join("");

  const s = getAdminSection();
  if (s) sectionSel.value = s;
}

function updateLinks(){
  const c = getAdminCourse();
  const s = getAdminSection();
  const q = `?course=${encodeURIComponent(c)}&section=${encodeURIComponent(s)}`;
  gLink.href = "grades.html" + q;
  aLink.href = "attendance.html" + q;
  pLink.href = "policies.html?course=" + encodeURIComponent(c);
}

async function loadReminders(){
  remList.innerHTML = `<div class="muted">جاري التحميل...</div>`;
  try{
    // نعرض نفس تذكيرات الطلاب لأن التخزين في Reminders حسب المقرر
    // نستخدم admin_reminder_add للكتابة، والقراءة نعيدها من نفس الرد بعد الإضافة
    remList.innerHTML = `<div class="muted">أضف تذكير وسيظهر هنا.</div>`;
  }catch(e){
    remList.innerHTML = `<div class="muted">${esc(e.message||e)}</div>`;
  }
}

async function addReminder(){
  try{
    const c = getAdminCourse();
    if (!c) { alert("اختر المقرر أولاً"); return; }

    const endIso = rEnd.value ? new Date(rEnd.value).toISOString() : "";
    const data = await api("admin_reminder_add", {
      course: c,
      title: rTitle.value.trim(),
      end_iso: endIso,
      note: rNote.value.trim()
    });

    const now = Date.now();
    remList.innerHTML = data.items.map(it=>{
      const done = it.end_ms && it.end_ms < now;
      const cls = done ? "rem done" : "rem red";
      const when = it.end_ms ? new Date(it.end_ms).toLocaleString("ar-SA") : "-";
      return `<div class="${cls}">
        <div><b>${esc(it.title||"")}</b></div>
        <div class="muted">ينتهي: ${esc(when)}</div>
        ${it.note ? `<div class="muted">${esc(it.note)}</div>` : ""}
      </div>`;
    }).join("");

    rTitle.value=""; rEnd.value=""; rNote.value="";
    alert("تمت إضافة التذكير");
  }catch(e){
    alert(e.message||e);
  }
}

async function init(){
  requireAdmin();
  msg.textContent = "جاري التحقق...";
  await api("admin_verify",{}); // إذا فشل سيظهر unauthorized
  msg.textContent = "";

  const data = await api("admin_courses_sections",{});
  map = data.items || [];
  fillCourses(map);
  courseSel.addEventListener("change", ()=>fillSections(map));
  updateLinks();
  await loadReminders();
}

function apply(){
  const c = courseSel.value;
  const s = sectionSel.value;
  if (!c) { alert("اختر المقرر"); return; }
  setAdminSelection(c,s);
  updateLinks();
  alert("تم تطبيق الاختيار");
}

init().catch(e=>alert(e.message||e));
</script>
</body>
</html>
