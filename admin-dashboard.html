<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المدرب</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">لوحة المدرب</div>
    <div class="actions">
      <button class="btn" onclick="exitAdminMode()">خروج المدرب</button>
      <a class="btn" href="index.html">الصفحة الرئيسية</a>
    </div>
  </div>

  <div class="card">
    <div class="h2">اختيار المقرر والشعبة</div>

    <div class="row" style="margin-top:12px">
      <select id="courseSel" class="input"></select>
      <select id="sectionSel" class="input"></select>
      <button class="btn primary" onclick="applySelection()">تطبيق</button>
    </div>

    <div class="muted" id="meta" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="h2">إضافة مقرر/شعبة (للمدرب)</div>
    <div class="row" style="margin-top:12px">
      <input id="newCourse" class="input" placeholder="كود المقرر مثل INET111">
      <input id="newSection" class="input" placeholder="الشعبة مثل INET111 2">
      <button class="btn" onclick="addCourse()">إضافة</button>
    </div>
    <div class="muted" id="addMsg" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="h2">الخدمات (حسب الشعبة المختارة)</div>
    <div class="row" style="margin-top:12px; flex-wrap:wrap">
      <a class="btn" id="lnkAttendance" href="#">سجل الحضور</a>
      <a class="btn" id="lnkGrades" href="#">سجل الدرجات</a>
      <a class="btn" id="lnkPolicies" href="#">سياسات المقرر</a>
      <a class="btn" id="lnkPlan" href="#">خطة المقرر</a>
      <a class="btn" id="lnkReminders" href="#">التذكيرات</a>
    </div>
  </div>
</div>

<script src="assets/app.js"></script>
<script>
  requireStudentOrAdmin();

  let all = [];

  function setLinks(course, section){
    // نخزن مرة واحدة + كل الصفحات تستخدم localStorage
    localStorage.setItem("admin_course", course||"");
    localStorage.setItem("admin_section", section||"");

    lnkAttendance.href = "attendance.html?admin=1";
    lnkGrades.href     = "grades.html?admin=1";
    lnkPolicies.href   = "policies.html?admin=1";
    lnkPlan.href       = "plan.html?admin=1";
    lnkReminders.href  = "dashboard.html?admin=1"; // إن كنت تستخدم نفس صفحة dashboard للتذكيرات، أو عدّل لرابط reminders.html لو عندك
  }

  function rebuildDropdowns(){
    // courses unique
    const courses = [...new Set(all.map(x=>x.course_code))];
    courseSel.innerHTML = courses.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

    const savedCourse = localStorage.getItem("admin_course") || courses[0] || "";
    courseSel.value = savedCourse;

    rebuildSections();
  }

  function rebuildSections(){
    const course = courseSel.value;
    const sections = all.filter(x=>x.course_code===course).map(x=>x.section);
    sectionSel.innerHTML = sections.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join("");

    const savedSec = localStorage.getItem("admin_section") || sections[0] || "";
    if (sections.includes(savedSec)) sectionSel.value = savedSec;

    meta.textContent = `المقرر: ${courseSel.value || "-"} | الشعبة: ${sectionSel.value || "-"}`;
    setLinks(courseSel.value, sectionSel.value);
  }

  async function init(){
    try{
      const data = await api("admin_courses_list", {});
      all = data.courses || [];
      if (!all.length){
        meta.textContent = "لا توجد مقررات/شعب. استخدم إضافة مقرر/شعبة.";
        return;
      }
      rebuildDropdowns();
      courseSel.onchange = rebuildSections;
      sectionSel.onchange = rebuildSections;
    }catch(e){
      alert(e.message || e);
    }
  }

  function applySelection(){
    meta.textContent = `تم اختيار: ${courseSel.value} / ${sectionSel.value}`;
    setLinks(courseSel.value, sectionSel.value);
  }

  async function addCourse(){
    addMsg.textContent = "جاري الإضافة...";
    try{
      await api("admin_courses_add", {
        course_code: newCourse.value.trim(),
        section: newSection.value.trim(),
        title: ""
      });
      addMsg.textContent = "تمت الإضافة.";
      // refresh
      const data = await api("admin_courses_list", {});
      all = data.courses || [];
      rebuildDropdowns();
    }catch(e){
      addMsg.textContent = e.message || e;
    }
  }

  init();
</script>
</body>
</html>
