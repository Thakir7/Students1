<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المدرب</title>
  <link rel="stylesheet" href="assets/style.css">
  <style>
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}
    .links{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .links .btn{min-width:160px}
  </style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">لوحة المدرب</div>
    <div class="actions">
      <a class="btn" href="index.html" onclick="clearAdminSession()">خروج</a>
    </div>
  </div>

  <div class="card">
    <div class="h2">اختيار المقرر والشعبة</div>

    <div class="grid2" style="margin-top:12px">
      <select id="courseSel" class="input"><option value="">اختر المقرر</option></select>
      <select id="sectionSel" class="input"><option value="">اختر الشعبة</option></select>
    </div>

    <div class="row" style="margin-top:12px;gap:10px">
      <button class="btn primary" id="applyBtn">تطبيق</button>
      <div class="muted" id="status"></div>
    </div>

    <div class="muted" id="picked" style="margin-top:10px"></div>

    <div class="links">
      <a class="btn" id="btnAttendance" href="#">سجل الحضور</a>
      <a class="btn" id="btnGrades" href="#">سجل الدرجات</a>
      <a class="btn" id="btnPlan" href="#">خطة المقرر</a>
      <a class="btn" id="btnPolicies" href="#">سياسات المقرر</a>
      <a class="btn" href="calendar.html">التقويم</a>
      <a class="btn" href="contact.html">التواصل</a>
    </div>
  </div>
</div>

<script src="assets/app.js"></script>
<script>
  requireAdmin();

  const courseSel = document.getElementById("courseSel");
  const sectionSel = document.getElementById("sectionSel");
  const statusEl = document.getElementById("status");
  const pickedEl = document.getElementById("picked");

  const btnAttendance = document.getElementById("btnAttendance");
  const btnGrades = document.getElementById("btnGrades");
  const btnPlan = document.getElementById("btnPlan");
  const btnPolicies = document.getElementById("btnPolicies");

  let rows = [];

  function setStatus(t){ statusEl.textContent = t||""; }

  function fillCourses(){
    const courses = [...new Set(rows.map(r=>r.course))];
    courseSel.innerHTML = `<option value="">اختر المقرر</option>` + courses.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
  }

  function fillSections(course){
    const sections = rows.filter(r=>r.course===course).map(r=>r.section);
    sectionSel.innerHTML = `<option value="">اختر الشعبة</option>` + sections.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join("");
  }

  function updateLinks(){
    const sel = getSelection();
    const c = sel.course || courseSel.value || "";
    const s = sel.section || sectionSel.value || "";
    btnAttendance.href = `attendance.html?mode=admin&course=${encodeURIComponent(c)}&section=${encodeURIComponent(s)}`;
    btnGrades.href = `grades.html?mode=admin&course=${encodeURIComponent(c)}&section=${encodeURIComponent(s)}`;
    btnPlan.href = `plan.html?mode=admin&course=${encodeURIComponent(c)}`;
    btnPolicies.href = `policies.html?mode=admin&course=${encodeURIComponent(c)}`;
  }

  async function loadAdminCourses(){
    setStatus("جاري تحميل القائمة...");
    const data = await api("admin_courses_list", {});
    rows = (data.rows||[]).map(r=>({
      course: (r.course||"").trim(),
      section: (r.section||"").trim(),
      active: String(r.active||"").toUpperCase().trim()
    })).filter(r=>r.course && r.section && (r.active==="" || r.active==="TRUE"));
    fillCourses();

    const saved = getSelection();
    if(saved.course){
      courseSel.value = saved.course;
      fillSections(saved.course);
      if(saved.section) sectionSel.value = saved.section;
      pickedEl.textContent = `المقرر: ${saved.course} — الشعبة: ${saved.section}`;
    }
    updateLinks();
    setStatus("");
  }

  courseSel.addEventListener("change", ()=>{
    fillSections(courseSel.value);
    updateLinks();
  });
  sectionSel.addEventListener("change", updateLinks);

  document.getElementById("applyBtn").onclick = ()=>{
    const c = courseSel.value;
    const s = sectionSel.value;
    if(!c) return alert("اختر المقرر");
    if(!s) return alert("اختر الشعبة");
    setSelection(c,s);
    pickedEl.textContent = `المقرر: ${c} — الشعبة: ${s}`;
    updateLinks();
    alert("تم حفظ الاختيار. الآن كل الخدمات تفتح مباشرة على نفس الشعبة.");
  };

  loadAdminCourses().catch(e=>alert(e.message||e));
</script>
</body>
</html>
