<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المدرب</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">لوحة المدرب</div>
    <div class="actions">
      <button class="btn" onclick="exitAdminMode()">خروج المدرب</button>
    </div>
  </div>

  <div class="card">
    <div class="h2">اختيار المقرر والشعبة</div>
    <div class="row" style="gap:10px; margin-top:10px">
      <select id="courseSel" class="input"></select>
      <select id="sectionSel" class="input"></select>
      <button class="btn primary" onclick="applyCtx()">تطبيق</button>
    </div>
    <div id="ctx" class="muted" style="margin-top:10px"></div>

    <div style="margin-top:12px">
      <a class="btn" id="goGrades" href="grades.html">سجل الدرجات</a>
      <a class="btn" id="goAtt" href="attendance.html">سجل الحضور</a>
      <a class="btn" id="goPlan" href="plan.html">خطة المقرر</a>
      <a class="btn" id="goPol" href="policies.html">سياسات المقرر</a>
    </div>
  </div>

  <div class="card">
    <div class="h2">إضافة مقرر/شعبة (إلى شيت Course)</div>
    <div class="row" style="gap:10px; margin-top:10px">
      <input id="newCourse" class="input" placeholder="Course مثال: INET111">
      <input id="newSection" class="input" placeholder="Section مثال: INET111 2">
      <button class="btn" onclick="addCourse()">إضافة</button>
    </div>
    <div id="addMsg" class="muted" style="margin-top:10px"></div>
  </div>
</div>

<script src="assets/app.js"></script>
<script>
  let all = [];

  function requireAdmin(){
    if (!isAdmin()) location.href = "admin-login.html";
  }

  function unique(arr){ return [...new Set(arr)]; }

  function fill(){
    const courses = unique(all.map(x=>x.course));
    courseSel.innerHTML = courses.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

    const savedC = localStorage.getItem("admin_course") || courses[0] || "";
    if (savedC) courseSel.value = savedC;

    refreshSections();
    const savedS = localStorage.getItem("admin_section") || "";
    if (savedS) sectionSel.value = savedS;

    updateLinks();
  }

  function refreshSections(){
    const c = courseSel.value;
    const secs = all.filter(x=>x.course===c).map(x=>x.section);
    sectionSel.innerHTML = secs.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join("");
  }

  function updateLinks(){
    const c = courseSel.value || "";
    const s = sectionSel.value || "";
    ctx.textContent = `المقرر: ${c || "-"} | الشعبة: ${s || "-"}`;

    // خزّنها بحيث كل صفحة تستخدمها بدون إعادة اختيار
    localStorage.setItem("admin_course", c);
    localStorage.setItem("admin_section", s);

    const q = `?course=${encodeURIComponent(c)}&section=${encodeURIComponent(s)}`;
    goGrades.href = "grades.html"+q;
    goAtt.href   = "attendance.html"+q;
    goPol.href   = "policies.html"+q;
    goPlan.href  = "plan.html"+q; // plan يعتمد على course
  }

  function applyCtx(){
    refreshSections();
    updateLinks();
  }

  async function addCourse(){
    addMsg.textContent = "جاري الإضافة...";
    try{
      await api("admin_courses_upsert", {
        course: (newCourse.value||"").trim(),
        section: (newSection.value||"").trim(),
        active: true
      });
      newCourse.value=""; newSection.value="";
      addMsg.textContent = "تمت الإضافة.";
      await load();
    }catch(e){
      addMsg.textContent = e.message || String(e);
    }
  }

  async function load(){
    requireAdmin();
    const data = await api("admin_courses_list",{});
    all = data.rows || [];
    fill();
  }

  courseSel.addEventListener("change", ()=>{ refreshSections(); updateLinks(); });
  sectionSel.addEventListener("change", ()=>updateLinks());

  load().catch(e=>alert(e.message||e));
</script>
</body>
</html>
