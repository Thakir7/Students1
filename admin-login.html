<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB99dmAbCJclwyipiM3f7pm9M1tofL6nZU",
    authDomain: "students1-bb615.firebaseapp.com",
    projectId: "students1-bb615",
    storageBucket: "students1-bb615.firebasestorage.app",
    messagingSenderId: "814840688419",
    appId: "1:814840688419:web:85a568e6969d2f4eca2696"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const msg = document.getElementById("msg");
  const email = document.getElementById("email");
  const pass = document.getElementById("pass");

  window.login = async function(){
    msg.textContent = "جاري تسجيل الدخول...";
    try{
      const userCred = await signInWithEmailAndPassword(auth, email.value.trim(), pass.value);
      const token = await userCred.user.getIdToken(true);

      // احفظ توكن فايربيس + وضع الادمن
      localStorage.setItem("firebase_token", token);
      localStorage.setItem("mode", "admin");

      // جرّب admin_login (بدون meta)
      const res = await fetch((window.API_URL || ""), {
        method: "POST",
        body: JSON.stringify({ action:"admin_login", firebase_token: token })
      });

      // إذا API_URL غير معرف داخل الصفحة، خذه من assets/app.js
      // الحل: نستخدم نفس API_URL عبر تحميل app.js
      // لذلك تأكد أنك تضيف <script src="assets/app.js"></script> قبل هذا السكربت أو استخدم السطر التالي:
      // const res = await fetch(API_URL, {method:"POST", body: JSON.stringify({action:"admin_login", firebase_token: token})});

    }catch(e){
      msg.textContent = "فشل الدخول: " + (e?.message || e);
      return;
    }

    // إذا وصلنا هنا بدون أخطاء: ادخل لوحة المدرب
    location.href = "admin-dashboard.html";
  };

  window.logout = async function(){
    try{ await signOut(auth); }catch(_){}
    localStorage.removeItem("firebase_token");
    localStorage.removeItem("mode");
    msg.textContent = "تم مسح دخول المدرب.";
  };
</script>
