<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>سياسات المقرر</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">سياسات المقرر التدريبي</div>
    <div class="actions">
      <a class="btn" href="dashboard.html">رجوع</a>
      <button class="btn" style="display:none" id="exitAdminBtn" onclick="exitAdmin()">خروج المدرب</button>
    </div>
  </div>

  <div class="card">
    <div id="meta" class="muted"></div>
    <div id="list"></div>

    <div id="adminBox" style="display:none; margin-top:14px">
      <hr style="border:none; border-top:1px solid #e5e7eb; margin:14px 0">
      <div class="h2">إضافة/تعديل السياسات (للمدرب)</div>
      <div class="muted">اكتب كل سياسة في سطر مستقل ثم حفظ.</div>
      <textarea id="polText" class="input" style="height:220px; margin-top:10px"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" onclick="savePolicies()">حفظ السياسات</button>
      </div>
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script src="assets/app.js"></script>
<script>
  let CURRENT_COURSE = "";

  async function loadPolicies(){
    const data = await api("policies_get", { course: CURRENT_COURSE });
    const items = data.items || [];
    if (!items.length){
      list.innerHTML = `<div class="muted">لا توجد سياسات.</div>`;
      return;
    }
    list.innerHTML = items.map((x,i)=>`
      <div style="padding:10px 0; border-bottom:1px solid #e5e7eb">
        <b>${i+1}.</b> ${esc(x.text)}
      </div>
    `).join("");
    if (isAdmin()){
      polText.value = items.map(x=>x.text).join("\n");
    }
  }

  async function savePolicies(){
    msg.textContent = "جاري الحفظ...";
    try{
      const lines = polText.value.split("\n").map(s=>s.trim()).filter(Boolean);
      await api("policies_save", { course: CURRENT_COURSE, lines });
      msg.textContent = "تم الحفظ ✅";
      await loadPolicies();
    }catch(e){
      msg.textContent = "خطأ: " + (e.message||e);
    }
  }

  async function init(){
    requireStudentOrAdmin();
    CURRENT_COURSE = isAdmin()? getAdminCourse() : getSelectedCourse();
    meta.textContent = `المقرر: ${CURRENT_COURSE||"-"}`;

    if (isAdmin()){
      exitAdminBtn.style.display="inline-flex";
      adminBox.style.display="block";
    }
    await loadPolicies();
  }

  init().catch(e=>alert(e.message||e));
</script>
</body>
</html>
